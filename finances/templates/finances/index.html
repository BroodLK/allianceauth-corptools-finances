{% extends 'finances/base.html' %}

{% load i18n %}
{% load humanize %}

{% block details %}
    <div class="container-fluid">
        <div class="card mb-3">
            <div class="card-header">{% translate "Filters" %}</div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="days" class="form-label">{% translate "Time Window" %}</label>
                        <select id="days" name="days" class="form-select">
                            {% for option in days_options %}
                                <option value="{{ option }}" {% if option == days %}selected{% endif %}>
                                    {% blocktranslate %}Last {{ option }} days{% endblocktranslate %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Custom range overrides this selection." %}</div>
                    </div>
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">{% translate "Start Date" %}</label>
                        <input
                            id="start_date"
                            name="start_date"
                            type="date"
                            class="form-control"
                            value="{{ custom_start_value }}"
                        >
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">{% translate "End Date" %}</label>
                        <input
                            id="end_date"
                            name="end_date"
                            type="date"
                            class="form-control"
                            value="{{ custom_end_value }}"
                        >
                    </div>
                    <div class="col-md-4">
                        <label for="divisions" class="form-label">{% translate "Wallet Divisions" %}</label>
                        <select id="divisions" name="divisions" class="form-select" multiple size="6">
                            {% for division in divisions %}
                                <option value="{{ division.id }}" {% if division.id in division_ids %}selected{% endif %}>
                                    {{ division.corporation.corporation.corporation_name }} -
                                    {{ division.division }}{% if division.name %} {{ division.name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Hold Ctrl/Cmd to select multiple divisions." %}</div>
                    </div>
                    <div class="col-md-5">
                        <label for="ref_types" class="form-label">{% translate "Income Reference Types" %}</label>
                        <select id="ref_types" name="ref_types" class="form-select" multiple size="6">
                            {% for ref in ref_type_choices %}
                                <option value="{{ ref.value }}" {% if ref.value in selected_ref_types %}selected{% endif %}>
                                    {{ ref.label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Leave empty to include all income types." %}</div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">{% translate "Apply Filters" %}</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Income (filtered)" %}</div>
                        <div class="fs-4 text-success">
                            {{ summary.income_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.income_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Expenses" %}</div>
                        <div class="fs-4 text-danger">
                            {{ summary.expense_total_abs|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.expense_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Net" %}</div>
                        <div class="fs-4">
                            {{ summary.net_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.entry_count }} {% translate "total entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Period" %}</div>
                        <div class="small">
                            {{ start_date|date:"Y-m-d" }} - {{ end_date|date:"Y-m-d" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 text-muted small">
            {% translate "Income totals respect the selected income reference types; expenses include all types." %}
        </div>

        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">{% translate "Income by Reference Type" %}</div>
                    <div class="card-body p-0">
                        <div class="p-3">
                            <div class="finances-line-chart" data-chart="income">
                                <svg viewBox="0 0 600 200" preserveAspectRatio="none" role="img" aria-label="{% translate "Income trend" %}">
                                    <path class="finances-line-chart__area" d=""></path>
                                    <path class="finances-line-chart__line" d=""></path>
                                </svg>
                                <div class="finances-line-chart__empty text-muted d-none">
                                    {% translate "No income data for this period." %}
                                </div>
                            </div>
                            {{ income_series|json_script:"income-series-data" }}
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th class="text-end">{% translate "Total" %}</th>
                                        <th class="text-end">{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in income_by_ref %}
                                        <tr>
                                            <td>{{ row.label }}</td>
                                            <td class="text-end">{{ row.total|floatformat:0|intcomma }}</td>
                                            <td class="text-end">{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No income entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">{% translate "Expenses by Reference Type" %}</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th class="text-end">{% translate "Total" %}</th>
                                        <th class="text-end">{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in expense_by_ref %}
                                        <tr>
                                            <td>{{ row.label }}</td>
                                            <td class="text-end">{{ row.total_abs|floatformat:0|intcomma }}</td>
                                            <td class="text-end">{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No expense entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">{% translate "Division Summary" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>{% translate "Corporation" %}</th>
                                <th>{% translate "Division" %}</th>
                                <th class="text-end">{% translate "Balance" %}</th>
                                <th class="text-end">{% translate "Income (filtered)" %}</th>
                                <th class="text-end">{% translate "Expenses" %}</th>
                                <th class="text-end">{% translate "Net" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in division_rows %}
                                <tr>
                                    <td>{{ row.corp_name }}</td>
                                    <td>{{ row.division }}{% if row.name %} {{ row.name }}{% endif %}</td>
                                    <td class="text-end">{{ row.balance|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.income|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.expenses|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.net|floatformat:0|intcomma }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        {% translate "No divisions available." %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascript %}
{% endblock %}

{% block extra_css %}
    <style>
        .finances-line-chart {
            position: relative;
            width: 100%;
            height: 180px;
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .finances-line-chart svg {
            width: 100%;
            height: 100%;
        }
        .finances-line-chart__line {
            fill: none;
            stroke: var(--bs-primary);
            stroke-width: 2;
        }
        .finances-line-chart__area {
            fill: var(--bs-primary-bg-subtle);
            opacity: 0.5;
        }
        .finances-line-chart__empty {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            background: var(--bs-body-bg);
        }
    </style>
{% endblock %}

{% block extra_script %}
    (function () {
        const dataElement = document.getElementById("income-series-data");
        const chart = document.querySelector('[data-chart="income"]');
        if (!dataElement || !chart) {
            return;
        }

        let data = [];
        try {
            data = JSON.parse(dataElement.textContent || "[]");
        } catch (err) {
            data = [];
        }

        const emptyState = chart.querySelector(".finances-line-chart__empty");
        const svg = chart.querySelector("svg");
        const area = chart.querySelector(".finances-line-chart__area");
        const line = chart.querySelector(".finances-line-chart__line");

        if (!svg || !area || !line) {
            return;
        }

        if (!data.length) {
            emptyState?.classList.remove("d-none");
            return;
        }

        const values = data.map((point) => Number(point.total) || 0);
        const maxValue = Math.max(...values);

        if (maxValue <= 0) {
            emptyState?.classList.remove("d-none");
            return;
        }

        const width = 600;
        const height = 200;
        const padding = 20;
        const baseline = height - padding;
        const top = padding;
        const usableHeight = baseline - top;
        const count = values.length;
        const step = count > 1 ? (width - padding * 2) / (count - 1) : 0;

        const points = values.map((value, index) => {
            const x = padding + index * step;
            const y = baseline - (value / maxValue) * usableHeight;
            return [x, y];
        });

        const linePath = points
            .map((point, index) => `${index === 0 ? "M" : "L"} ${point[0]} ${point[1]}`)
            .join(" ");

        const areaPath = [
            `M ${points[0][0]} ${baseline}`,
            ...points.map((point, index) => `${index === 0 ? "L" : "L"} ${point[0]} ${point[1]}`),
            `L ${points[points.length - 1][0]} ${baseline}`,
            "Z",
        ].join(" ");

        area.setAttribute("d", areaPath);
        line.setAttribute("d", linePath);
    })();
{% endblock %}
