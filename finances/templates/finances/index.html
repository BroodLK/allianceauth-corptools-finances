{% extends 'finances/base.html' %}

{% load i18n %}
{% load humanize %}

{% block details %}
    <div class="container-fluid">
        <div class="card mb-3">
            <div class="card-header">{% translate "Filters" %}</div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="days" class="form-label">{% translate "Time Window" %}</label>
                        <select id="days" name="days" class="form-select">
                            {% for option in days_options %}
                                <option value="{{ option }}" {% if option == days %}selected{% endif %}>
                                    {% blocktranslate %}Last {{ option }} days{% endblocktranslate %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Custom range overrides this selection." %}</div>
                    </div>
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">{% translate "Start Date" %}</label>
                        <input
                            id="start_date"
                            name="start_date"
                            type="date"
                            class="form-control"
                            value="{{ custom_start_value }}"
                        >
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">{% translate "End Date" %}</label>
                        <input
                            id="end_date"
                            name="end_date"
                            type="date"
                            class="form-control"
                            value="{{ custom_end_value }}"
                        >
                    </div>
                    <div class="col-md-4">
                        <label for="divisions" class="form-label">{% translate "Wallet Divisions" %}</label>
                        <select id="divisions" name="divisions" class="form-select finances-select finances-select--neutral" multiple size="6">
                            {% for division in divisions %}
                                <option value="{{ division.id }}" {% if division.id in division_ids %}selected{% endif %}>
                                    {{ division.corporation.corporation.corporation_name }} -
                                    {{ division.division }}{% if division.name %} {{ division.name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Hold Ctrl/Cmd to select multiple divisions." %}</div>
                        <div
                            class="finances-selected"
                            data-selected-list="divisions"
                            data-badge-class="bg-secondary-subtle text-secondary-emphasis"
                            data-empty-text="{% translate "None" %}"
                        >
                            <div class="finances-selected__label small text-muted">{% translate "Selected" %}:</div>
                            <div class="finances-selected__list">
                                {% for division in divisions %}
                                    {% if division.id in division_ids %}
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis">
                                            {{ division.corporation.corporation.corporation_name }} -
                                            {{ division.division }}{% if division.name %} {{ division.name }}{% endif %}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="ref_types" class="form-label">{% translate "Income Reference Types" %}</label>
                        <select id="ref_types" name="ref_types" class="form-select finances-select finances-select--income" multiple size="6">
                            {% for ref in ref_type_choices %}
                                <option value="{{ ref.value }}" {% if ref.value in selected_ref_types %}selected{% endif %}>
                                    {{ ref.label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Leave empty to include all income types." %}</div>
                        <div
                            class="finances-selected"
                            data-selected-list="ref_types"
                            data-badge-class="bg-primary-subtle text-primary-emphasis"
                            data-empty-text="{% translate "None" %}"
                        >
                            <div class="finances-selected__label small text-muted">{% translate "Selected" %}:</div>
                            <div class="finances-selected__list">
                                {% for ref in ref_type_choices %}
                                    {% if ref.value in selected_ref_types %}
                                        <span class="badge bg-primary-subtle text-primary-emphasis">
                                            {{ ref.label }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="expense_ref_types" class="form-label">{% translate "Expense Reference Types" %}</label>
                        <select id="expense_ref_types" name="expense_ref_types" class="form-select finances-select finances-select--expense" multiple size="6">
                            {% for ref in expense_ref_type_choices %}
                                <option value="{{ ref.value }}" {% if ref.value in selected_expense_ref_types %}selected{% endif %}>
                                    {{ ref.label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Leave empty to include all expense types." %}</div>
                        <div
                            class="finances-selected"
                            data-selected-list="expense_ref_types"
                            data-badge-class="bg-danger-subtle text-danger-emphasis"
                            data-empty-text="{% translate "None" %}"
                        >
                            <div class="finances-selected__label small text-muted">{% translate "Selected" %}:</div>
                            <div class="finances-selected__list">
                                {% for ref in expense_ref_type_choices %}
                                    {% if ref.value in selected_expense_ref_types %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis">
                                            {{ ref.label }}
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">{% translate "Apply Filters" %}</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Income (filtered)" %}</div>
                        <div class="fs-4 text-success">
                            {{ summary.income_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.income_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Expenses (filtered)" %}</div>
                        <div class="fs-4 text-danger">
                            {{ summary.expense_total_abs|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.expense_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Net" %}</div>
                        <div class="fs-4 {% if summary.net_total < 0 %}text-danger{% elif summary.net_total > 0 %}text-success{% endif %}">
                            {{ summary.net_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.entry_count }} {% translate "total entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Period" %}</div>
                        <div class="small">
                            {{ start_date|date:"Y-m-d" }} - {{ end_date|date:"Y-m-d" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 text-muted small">
            {% translate "Income and expense totals respect their selected reference types." %}
        </div>

        <div class="row g-3">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header">{% translate "Income by Reference Type" %}</div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                            <div>
                                <div class="fw-semibold">{% translate "Daily income trend" %}</div>
                                <div class="text-muted small">
                                    {% blocktranslate %}From {{ start_date|date:"Y-m-d" }} to {{ end_date|date:"Y-m-d" }}{% endblocktranslate %}
                                </div>
                            </div>
                            <div class="finances-legend">
                                <span class="finances-legend__item">
                                    <span class="finances-legend__swatch" data-theme="income"></span>
                                    {% translate "Income (filtered)" %}
                                </span>
                            </div>
                        </div>
                        <div class="row row-cols-2 row-cols-md-4 g-2 text-center small mb-3">
                            <div class="col">
                                <div class="text-muted">{% translate "Total" %}</div>
                                <div class="fw-semibold">{{ income_stats.total|floatformat:0|intcomma }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Avg / Day" %}</div>
                                <div class="fw-semibold">{{ income_stats.avg|floatformat:0|intcomma }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Peak Day" %}</div>
                                <div class="fw-semibold">{{ income_stats.max|floatformat:0|intcomma }}</div>
                                <div class="text-muted">{{ income_stats.max_date|date:"Y-m-d" }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Active Days" %}</div>
                                <div class="fw-semibold">{{ income_stats.active_days }}/{{ income_stats.days }}</div>
                            </div>
                        </div>
                        <div class="finances-line-chart" data-chart="income" data-theme="income">
                            <svg viewBox="0 0 600 440" preserveAspectRatio="none" role="img" aria-label="{% translate "Income trend" %}">
                                <g data-grid></g>
                                <g data-axis></g>
                                <path class="finances-line-chart__area" d=""></path>
                                <path class="finances-line-chart__line" d=""></path>
                                <line class="finances-line-chart__hover-line" x1="0" y1="0" x2="0" y2="0"></line>
                                <circle class="finances-line-chart__hover-point" cx="0" cy="0" r="3"></circle>
                            </svg>
                            <div class="finances-line-chart__tooltip d-none"></div>
                            <div class="finances-line-chart__empty text-muted d-none">
                                {% translate "No income data for this period." %}
                            </div>
                        </div>
                        {{ income_series|json_script:"income-series-data" }}
                        <div class="table-responsive mt-3">
                            <table class="table table-sm mb-0 finances-table-centered">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th>{% translate "Total" %}</th>
                                        <th>{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in income_by_ref %}
                                        <tr class="finances-drill-row" data-drill="income_ref" data-ref-type="{{ row.ref_type }}">
                                            <td>{{ row.label }}</td>
                                            <td>{{ row.total|floatformat:0|intcomma }}</td>
                                            <td>{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No income entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mt-0">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header">{% translate "Expenses by Reference Type" %}</div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                            <div>
                                <div class="fw-semibold">{% translate "Daily expense trend" %}</div>
                                <div class="text-muted small">
                                    {% blocktranslate %}From {{ start_date|date:"Y-m-d" }} to {{ end_date|date:"Y-m-d" }}{% endblocktranslate %}
                                </div>
                            </div>
                            <div class="finances-legend">
                                <span class="finances-legend__item">
                                    <span class="finances-legend__swatch" data-theme="expenses"></span>
                                    {% translate "Expenses" %}
                                </span>
                            </div>
                        </div>
                        <div class="row row-cols-2 row-cols-md-4 g-2 text-center small mb-3">
                            <div class="col">
                                <div class="text-muted">{% translate "Total" %}</div>
                                <div class="fw-semibold">{{ expense_stats.total|floatformat:0|intcomma }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Avg / Day" %}</div>
                                <div class="fw-semibold">{{ expense_stats.avg|floatformat:0|intcomma }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Peak Day" %}</div>
                                <div class="fw-semibold">{{ expense_stats.max|floatformat:0|intcomma }}</div>
                                <div class="text-muted">{{ expense_stats.max_date|date:"Y-m-d" }}</div>
                            </div>
                            <div class="col">
                                <div class="text-muted">{% translate "Active Days" %}</div>
                                <div class="fw-semibold">{{ expense_stats.active_days }}/{{ expense_stats.days }}</div>
                            </div>
                        </div>
                        <div class="finances-line-chart" data-chart="expenses" data-theme="expenses">
                            <svg viewBox="0 0 600 440" preserveAspectRatio="none" role="img" aria-label="{% translate "Expense trend" %}">
                                <g data-grid></g>
                                <g data-axis></g>
                                <path class="finances-line-chart__area" d=""></path>
                                <path class="finances-line-chart__line" d=""></path>
                                <line class="finances-line-chart__hover-line" x1="0" y1="0" x2="0" y2="0"></line>
                                <circle class="finances-line-chart__hover-point" cx="0" cy="0" r="3"></circle>
                            </svg>
                            <div class="finances-line-chart__tooltip d-none"></div>
                            <div class="finances-line-chart__empty text-muted d-none">
                                {% translate "No expense data for this period." %}
                            </div>
                        </div>
                        {{ expense_series|json_script:"expense-series-data" }}
                        <div class="table-responsive mt-3">
                            <table class="table table-sm mb-0 finances-table-centered">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th>{% translate "Total" %}</th>
                                        <th>{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in expense_by_ref %}
                                        <tr class="finances-drill-row" data-drill="expense_ref" data-ref-type="{{ row.ref_type }}">
                                            <td>{{ row.label }}</td>
                                            <td>{{ row.total_abs|floatformat:0|intcomma }}</td>
                                            <td>{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No expense entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">{% translate "Division Summary" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 finances-table-centered">
                        <thead>
                            <tr>
                                <th>{% translate "Corporation" %}</th>
                                <th>{% translate "Division" %}</th>
                                <th>{% translate "Balance" %}</th>
                                <th>{% translate "Income (filtered)" %}</th>
                                <th>{% translate "Expenses" %}</th>
                                <th>{% translate "Net" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in division_rows %}
                                <tr class="finances-drill-row" data-drill="division" data-division-id="{{ row.division_id }}">
                                    <td>{{ row.corp_name }}</td>
                                    <td>{{ row.division }}{% if row.name %} {{ row.name }}{% endif %}</td>
                                    <td>{{ row.balance|floatformat:0|intcomma }}</td>
                                    <td>{{ row.income|floatformat:0|intcomma }}</td>
                                    <td>{{ row.expenses|floatformat:0|intcomma }}</td>
                                    <td>
                                        <span class="{% if row.net < 0 %}text-danger{% elif row.net > 0 %}text-success{% endif %}">
                                            {{ row.net|floatformat:0|intcomma }}
                                        </span>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        {% translate "No divisions available." %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if drilldown %}
            <div class="card mt-3" id="drilldown">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <div>
                        {% translate "Drilldown" %}: {{ drilldown.title }}
                        <span class="text-muted small">({{ drilldown.count }} {% translate "entries" %})</span>
                    </div>
                    {% if drilldown.clear_query %}
                        <a class="btn btn-sm btn-outline-secondary" href="?{{ drilldown.clear_query }}">
                            {% translate "Clear drilldown" %}
                        </a>
                    {% else %}
                        <a class="btn btn-sm btn-outline-secondary" href="?">
                            {% translate "Clear drilldown" %}
                        </a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>{% translate "Date" %}</th>
                                    <th>{% translate "Entry ID" %}</th>
                                    <th>{% translate "Corporation" %}</th>
                                    <th>{% translate "Division" %}</th>
                                    <th>{% translate "Ref Type" %}</th>
                                    <th>{% translate "Amount" %}</th>
                                    <th>{% translate "Balance" %}</th>
                                    <th>{% translate "First Party" %}</th>
                                    <th>{% translate "Second Party" %}</th>
                                    <th>{% translate "Context Type" %}</th>
                                    <th>{% translate "Context ID" %}</th>
                                    <th>{% translate "Description" %}</th>
                                    <th>{% translate "Reason" %}</th>
                                    <th>{% translate "Tax" %}</th>
                                    <th>{% translate "Tax Receiver" %}</th>
                                    <th>{% translate "Processed" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in drilldown.rows %}
                                    <tr>
                                        <td>{{ row.date|date:"Y-m-d H:i" }}</td>
                                        <td>{{ row.entry_id }}</td>
                                        <td>{{ row.corp_name }}</td>
                                        <td>{{ row.division }}{% if row.division_name %} {{ row.division_name }}{% endif %}</td>
                                        <td>{{ row.ref_type }}</td>
                                        <td>{{ row.amount|floatformat:2|intcomma }}</td>
                                        <td>{{ row.balance|floatformat:2|intcomma }}</td>
                                        <td>
                                            {{ row.first_party_name }}
                                            {% if row.first_party_id %} ({{ row.first_party_id }}){% endif %}
                                            {% if row.first_party_category %} - {{ row.first_party_category }}{% endif %}
                                        </td>
                                        <td>
                                            {{ row.second_party_name }}
                                            {% if row.second_party_id %} ({{ row.second_party_id }}){% endif %}
                                            {% if row.second_party_category %} - {{ row.second_party_category }}{% endif %}
                                        </td>
                                        <td>{{ row.context_id_type }}</td>
                                        <td>{{ row.context_id }}</td>
                                        <td>{{ row.description }}</td>
                                        <td>{{ row.reason }}</td>
                                        <td>{{ row.tax|floatformat:2|intcomma }}</td>
                                        <td>{{ row.tax_receiver_id }}</td>
                                        <td>{{ row.processed }}</td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="16" class="text-center text-muted">
                                            {% translate "No matching transactions." %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_javascript %}
{% endblock %}

{% block extra_css %}
    <style>
        .finances-table-centered th,
        .finances-table-centered td {
            text-align: center;
            vertical-align: middle;
        }
        .finances-select {
            background-color: var(--bs-body-bg);
        }
        .finances-select option {
            color: var(--bs-body-color);
        }
        .finances-select option:checked {
            background-color: var(--bs-secondary-bg-subtle);
            color: var(--bs-body-color);
        }
        .finances-select--income option:checked {
            background-color: var(--bs-primary-bg-subtle);
        }
        .finances-select--expense option:checked {
            background-color: var(--bs-danger-bg-subtle);
        }
        .finances-selected {
            margin-top: 0.5rem;
        }
        .finances-selected__list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        .finances-selected__empty {
            font-size: 0.75rem;
            color: var(--bs-secondary-color);
        }
        .finances-drill-row {
            cursor: pointer;
        }
        .finances-drill-row:hover {
            background-color: var(--bs-secondary-bg-subtle);
        }
        .finances-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            font-size: 0.85rem;
            color: var(--bs-secondary-color);
        }
        .finances-legend__item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .finances-legend__swatch {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            border: 1px solid var(--bs-border-color);
            background: var(--bs-primary);
        }
        .finances-legend__swatch[data-theme="expenses"] {
            background: var(--bs-danger);
        }
        .finances-legend__swatch[data-theme="income"] {
            background: var(--bs-primary);
        }
        .finances-line-chart {
            position: relative;
            width: 100%;
            height: 440px;
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
            --chart-line: var(--bs-primary);
            --chart-fill: var(--bs-primary-bg-subtle);
        }
        .finances-line-chart[data-theme="expenses"] {
            --chart-line: var(--bs-danger);
            --chart-fill: var(--bs-danger-bg-subtle);
        }
        .finances-line-chart svg {
            width: 100%;
            height: 100%;
        }
        .finances-line-chart__line {
            fill: none;
            stroke: var(--chart-line);
            stroke-width: 2;
        }
        .finances-line-chart__area {
            fill: var(--chart-fill);
            opacity: 0.45;
        }
        .finances-line-chart__grid-line {
            stroke: var(--bs-border-color);
            stroke-dasharray: 3 3;
        }
        .finances-line-chart__axis text {
            fill: var(--bs-secondary-color);
            font-size: 10px;
        }
        .finances-line-chart__hover-line {
            stroke: var(--bs-secondary-color);
            stroke-width: 1;
            stroke-dasharray: 4 4;
            opacity: 0;
        }
        .finances-line-chart__hover-point {
            fill: var(--chart-line);
            stroke: var(--bs-body-bg);
            stroke-width: 1.5;
            opacity: 0;
        }
        .finances-line-chart__tooltip {
            position: absolute;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            font-size: 0.75rem;
            color: var(--bs-body-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            pointer-events: none;
            transform: translate(-50%, -120%);
            white-space: nowrap;
        }
        .finances-line-chart__empty {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            background: var(--bs-body-bg);
        }
    </style>
{% endblock %}

{% block extra_script %}
    (function () {
        const charts = [
            {
                dataId: "income-series-data",
                selector: '[data-chart="income"]',
                label: "Income",
            },
            {
                dataId: "expense-series-data",
                selector: '[data-chart="expenses"]',
                label: "Expenses",
            },
        ];

        const numberFormatter = new Intl.NumberFormat(undefined, {
            maximumFractionDigits: 0,
        });
        const axisNumberFormatter = new Intl.NumberFormat(undefined, {
            maximumFractionDigits: 1,
        });

        const renderChart = (chart, data) => {
            const emptyState = chart.querySelector(".finances-line-chart__empty");
            const svg = chart.querySelector("svg");
            const area = chart.querySelector(".finances-line-chart__area");
            const line = chart.querySelector(".finances-line-chart__line");
            const grid = chart.querySelector("[data-grid]");
            const axis = chart.querySelector("[data-axis]");
            const hoverLine = chart.querySelector(".finances-line-chart__hover-line");
            const hoverPoint = chart.querySelector(".finances-line-chart__hover-point");
            const tooltip = chart.querySelector(".finances-line-chart__tooltip");

            if (!svg || !area || !line || !grid || !axis) {
                return;
            }

            if (!data.length) {
                emptyState?.classList.remove("d-none");
                return;
            }

            const values = data.map((point) => Number(point.total) || 0);
            const maxValue = Math.max(...values);

            if (maxValue <= 0) {
                emptyState?.classList.remove("d-none");
                return;
            }

            const width = 600;
            const height = 440;
            const padding = {
                top: 24,
                right: 24,
                bottom: 40,
                left: 64,
            };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            const count = values.length;
            const step = count > 1 ? chartWidth / (count - 1) : 0;

            const points = values.map((value, index) => {
                const x = padding.left + index * step;
                const y = padding.top + chartHeight - (value / maxValue) * chartHeight;
                return {
                    x,
                    y,
                    value,
                    date: data[index].date,
                };
            });

            grid.innerHTML = "";
            axis.innerHTML = "";
            axis.classList.add("finances-line-chart__axis");

            const ns = "http://www.w3.org/2000/svg";
            const tickCount = 10;
            for (let i = 0; i <= tickCount; i += 1) {
                const y = padding.top + (chartHeight / tickCount) * i;
                const value = Math.round(maxValue * (1 - i / tickCount));
                const gridLine = document.createElementNS(ns, "line");
                gridLine.setAttribute("x1", padding.left);
                gridLine.setAttribute("x2", width - padding.right);
                gridLine.setAttribute("y1", y);
                gridLine.setAttribute("y2", y);
                gridLine.setAttribute("class", "finances-line-chart__grid-line");
                grid.appendChild(gridLine);

                const label = document.createElementNS(ns, "text");
                label.setAttribute("x", padding.left - 6);
                label.setAttribute("y", y + 4);
                label.setAttribute("text-anchor", "end");
                const valueMillions = value / 1000000;
                label.textContent = `${axisNumberFormatter.format(valueMillions)}M`;
                axis.appendChild(label);
            }

            const axisLabel = document.createElementNS(ns, "text");
            axisLabel.setAttribute("x", padding.left);
            axisLabel.setAttribute("y", padding.top - 8);
            axisLabel.setAttribute("text-anchor", "start");
            axisLabel.textContent = "ISK (M)";
            axis.appendChild(axisLabel);

            const includeYear = count > 180;
            const dateFormatterOptions = {
                month: "short",
                day: "numeric",
            };
            if (includeYear) {
                dateFormatterOptions.year = "numeric";
            }
            const dateFormatter = new Intl.DateTimeFormat(undefined, dateFormatterOptions);
            const tooltipDateFormatter = new Intl.DateTimeFormat(undefined, {
                month: "short",
                day: "numeric",
                year: "numeric",
            });

            const xTickCount = 15;
            const tickIndexes = Array.from(new Set(
                Array.from({ length: xTickCount + 1 }, (_, idx) =>
                    Math.round((count - 1) * (idx / xTickCount))
                )
            )).sort((a, b) => a - b);

            tickIndexes.forEach((index) => {
                const point = points[index];
                const label = document.createElementNS(ns, "text");
                label.setAttribute("x", point.x);
                label.setAttribute("y", height - 8);
                label.setAttribute("text-anchor", "middle");
                label.textContent = dateFormatter.format(new Date(point.date));
                axis.appendChild(label);
            });

            const linePath = points
                .map((point, index) => `${index === 0 ? "M" : "L"} ${point.x} ${point.y}`)
                .join(" ");

            const areaPath = [
                `M ${points[0].x} ${padding.top + chartHeight}`,
                ...points.map((point) => `L ${point.x} ${point.y}`),
                `L ${points[points.length - 1].x} ${padding.top + chartHeight}`,
                "Z",
            ].join(" ");

            area.setAttribute("d", areaPath);
            line.setAttribute("d", linePath);

            const showHover = (index) => {
                if (!hoverLine || !hoverPoint || !tooltip) {
                    return;
                }
                const point = points[index];
                hoverLine.setAttribute("x1", point.x);
                hoverLine.setAttribute("x2", point.x);
                hoverLine.setAttribute("y1", padding.top);
                hoverLine.setAttribute("y2", padding.top + chartHeight);
                hoverLine.style.opacity = "1";
                hoverPoint.setAttribute("cx", point.x);
                hoverPoint.setAttribute("cy", point.y);
                hoverPoint.style.opacity = "1";

                const chartRect = chart.getBoundingClientRect();
                const svgRect = svg.getBoundingClientRect();
                const left = (point.x / width) * svgRect.width + (svgRect.left - chartRect.left);
                const top = (point.y / height) * svgRect.height + (svgRect.top - chartRect.top);

                tooltip.textContent = `${tooltipDateFormatter.format(new Date(point.date))} \u2022 ${numberFormatter.format(point.value)} ISK`;
                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;
                tooltip.classList.remove("d-none");
            };

            const hideHover = () => {
                if (hoverLine) {
                    hoverLine.style.opacity = "0";
                }
                if (hoverPoint) {
                    hoverPoint.style.opacity = "0";
                }
                if (tooltip) {
                    tooltip.classList.add("d-none");
                }
            };

            chart.addEventListener("mousemove", (event) => {
                const rect = svg.getBoundingClientRect();
                const relativeX = ((event.clientX - rect.left) / rect.width) * width;
                const clampedX = Math.max(padding.left, Math.min(width - padding.right, relativeX));
                const index = count > 1
                    ? Math.round(((clampedX - padding.left) / chartWidth) * (count - 1))
                    : 0;
                showHover(index);
            });

            chart.addEventListener("mouseleave", hideHover);
        };

        charts.forEach(({ dataId, selector }) => {
            const dataElement = document.getElementById(dataId);
            const chart = document.querySelector(selector);
            if (!dataElement || !chart) {
                return;
            }

            let data = [];
            try {
                data = JSON.parse(dataElement.textContent || "[]");
            } catch (err) {
                data = [];
            }

            renderChart(chart, data);
        });

        const updateSelectedList = (select, list, badgeClass, emptyText) => {
            list.innerHTML = "";
            const selected = Array.from(select.selectedOptions);
            if (!selected.length) {
                const empty = document.createElement("span");
                empty.className = "finances-selected__empty";
                empty.textContent = emptyText;
                list.appendChild(empty);
                return;
            }
            selected.forEach((option) => {
                const badge = document.createElement("span");
                badge.className = `badge ${badgeClass}`;
                badge.textContent = option.textContent.trim();
                list.appendChild(badge);
            });
        };

        document.querySelectorAll(".finances-selected[data-selected-list]").forEach((container) => {
            const selectId = container.getAttribute("data-selected-list");
            const badgeClass = container.getAttribute("data-badge-class") || "bg-secondary-subtle";
            const emptyText = container.getAttribute("data-empty-text") || "None";
            const select = document.getElementById(selectId);
            const list = container.querySelector(".finances-selected__list");
            if (!select || !list) {
                return;
            }
            const render = () => updateSelectedList(select, list, badgeClass, emptyText);
            render();
            select.addEventListener("change", render);
        });

        document.querySelectorAll(".finances-drill-row[data-drill]").forEach((row) => {
            const handleDrill = () => {
                const drillType = row.getAttribute("data-drill");
                const refType = row.getAttribute("data-ref-type");
                const divisionId = row.getAttribute("data-division-id");
                if (!drillType) {
                    return;
                }

                const params = new URLSearchParams(window.location.search);
                params.set("drill", drillType);
                if (drillType === "income_ref" || drillType === "expense_ref") {
                    if (refType) {
                        params.set("ref_type", refType);
                    }
                    params.delete("division_id");
                } else if (drillType === "division") {
                    if (divisionId) {
                        params.set("division_id", divisionId);
                    }
                    params.delete("ref_type");
                }
                const query = params.toString();
                const url = `${window.location.pathname}?${query}#drilldown`;
                window.location.assign(url);
            };

            row.addEventListener("click", handleDrill);
            row.addEventListener("keypress", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    handleDrill();
                }
            });
            row.setAttribute("tabindex", "0");
            row.setAttribute("role", "button");
            row.setAttribute("title", "View transactions");
        });
    })();
{% endblock %}
