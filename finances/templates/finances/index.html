{% extends 'finances/base.html' %}

{% load i18n %}
{% load humanize %}

{% block details %}
    <div class="container-fluid">
        <div class="card mb-3">
            <div class="card-header">{% translate "Filters" %}</div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="days" class="form-label">{% translate "Time Window" %}</label>
                        <select id="days" name="days" class="form-select">
                            {% for option in days_options %}
                                <option value="{{ option }}" {% if option == days %}selected{% endif %}>
                                    {% blocktranslate %}Last {{ option }} days{% endblocktranslate %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="divisions" class="form-label">{% translate "Wallet Divisions" %}</label>
                        <select id="divisions" name="divisions" class="form-select" multiple size="6">
                            {% for division in divisions %}
                                <option value="{{ division.id }}" {% if division.id in division_ids %}selected{% endif %}>
                                    {{ division.corporation.corporation.corporation_name }} -
                                    {{ division.division }}{% if division.name %} {{ division.name }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Hold Ctrl/Cmd to select multiple divisions." %}</div>
                    </div>
                    <div class="col-md-5">
                        <label for="ref_types" class="form-label">{% translate "Income Reference Types" %}</label>
                        <select id="ref_types" name="ref_types" class="form-select" multiple size="6">
                            {% for ref in ref_type_choices %}
                                <option value="{{ ref.value }}" {% if ref.value in selected_ref_types %}selected{% endif %}>
                                    {{ ref.label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">{% translate "Leave empty to include all income types." %}</div>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-primary" type="submit">{% translate "Apply Filters" %}</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Income (filtered)" %}</div>
                        <div class="fs-4 text-success">
                            {{ summary.income_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.income_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-danger">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Expenses" %}</div>
                        <div class="fs-4 text-danger">
                            {{ summary.expense_total_abs|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.expense_count }} {% translate "entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Net" %}</div>
                        <div class="fs-4">
                            {{ summary.net_total|floatformat:0|intcomma }}
                        </div>
                        <div class="small text-muted">
                            {{ summary.entry_count }} {% translate "total entries" %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="text-muted">{% translate "Period" %}</div>
                        <div class="small">
                            {{ start_date|date:"Y-m-d" }} - {{ end_date|date:"Y-m-d" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3 text-muted small">
            {% translate "Income totals respect the selected income reference types; expenses include all types." %}
        </div>

        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">{% translate "Income by Reference Type" %}</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th class="text-end">{% translate "Total" %}</th>
                                        <th class="text-end">{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in income_by_ref %}
                                        <tr>
                                            <td>{{ row.label }}</td>
                                            <td class="text-end">{{ row.total|floatformat:0|intcomma }}</td>
                                            <td class="text-end">{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No income entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">{% translate "Expenses by Reference Type" %}</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>{% translate "Type" %}</th>
                                        <th class="text-end">{% translate "Total" %}</th>
                                        <th class="text-end">{% translate "Entries" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in expense_by_ref %}
                                        <tr>
                                            <td>{{ row.label }}</td>
                                            <td class="text-end">{{ row.total_abs|floatformat:0|intcomma }}</td>
                                            <td class="text-end">{{ row.count }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">
                                                {% translate "No expense entries found for this period." %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">{% translate "Division Summary" %}</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>{% translate "Corporation" %}</th>
                                <th>{% translate "Division" %}</th>
                                <th class="text-end">{% translate "Balance" %}</th>
                                <th class="text-end">{% translate "Income (filtered)" %}</th>
                                <th class="text-end">{% translate "Expenses" %}</th>
                                <th class="text-end">{% translate "Net" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in division_rows %}
                                <tr>
                                    <td>{{ row.corp_name }}</td>
                                    <td>{{ row.division }}{% if row.name %} {{ row.name }}{% endif %}</td>
                                    <td class="text-end">{{ row.balance|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.income|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.expenses|floatformat:0|intcomma }}</td>
                                    <td class="text-end">{{ row.net|floatformat:0|intcomma }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        {% translate "No divisions available." %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascript %}
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_script %}
{% endblock %}
